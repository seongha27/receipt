<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 리뷰 관리 시스템 - 완전 버전</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- 로딩 -->
        <div v-if="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">{{ loadingMessage }}</p>
            </div>
        </div>

        <!-- 헤더 -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">🚀 네이버 리뷰 관리 시스템</h1>
                    <div v-if="user" class="flex items-center space-x-4">
                        <span class="text-blue-100">{{ user.full_name || user.username }}님</span>
                        <span :class="user.role === 'admin' ? 'bg-red-500' : 'bg-blue-500'" 
                              class="px-3 py-1 rounded text-xs">
                            {{ user.role === 'admin' ? '관리자' : '리뷰어' }}
                        </span>
                        <button @click="logout" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 로그인 폼 -->
        <div v-if="!user" class="min-h-screen flex items-center justify-center">
            <div class="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">로그인</h2>
                    <p class="text-gray-600 mt-2">네이버 리뷰 관리 시스템</p>
                </div>
                
                <form @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">사용자명</label>
                        <input v-model="loginForm.username" type="text" required
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input v-model="loginForm.password" type="password" required
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium">
                        로그인
                    </button>
                </form>
                
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-2">테스트 계정</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>관리자:</strong> admin / admin123</p>
                        <p><strong>리뷰어:</strong> reviewer / reviewer123</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 대시보드 -->
        <div v-if="user" class="max-w-7xl mx-auto px-4 py-8">
            
            <!-- 탭 네비게이션 -->
            <div class="mb-8">
                <nav class="flex space-x-8 border-b border-gray-200">
                    <button @click="activeTab = 'dashboard'" 
                            :class="activeTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        📊 대시보드
                    </button>
                    <button @click="activeTab = 'reviews'" 
                            :class="activeTab === 'reviews' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        📝 리뷰 관리
                    </button>
                    <button v-if="user.role === 'admin'" @click="activeTab = 'stores'" 
                            :class="activeTab === 'stores' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        🏪 업체 관리
                    </button>
                    <button v-if="user.role === 'admin'" @click="activeTab = 'users'" 
                            :class="activeTab === 'users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        👥 사용자 관리
                    </button>
                    <button v-if="user.role === 'admin'" @click="activeTab = 'google-sheets'" 
                            :class="activeTab === 'google-sheets' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        📊 구글 시트
                    </button>
                    <button v-if="user.role === 'admin'" @click="activeTab = 'assignments'" 
                            :class="activeTab === 'assignments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        🔗 할당 관리
                    </button>
                </nav>
            </div>

            <!-- 대시보드 탭 -->
            <div v-if="activeTab === 'dashboard'" class="space-y-6">
                <!-- 통계 카드들 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                📝
                            </div>
                            <div class="ml-4">
                                <p class="text-gray-600 text-sm">총 리뷰</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.total_reviews || 0 }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                ⏳
                            </div>
                            <div class="ml-4">
                                <p class="text-gray-600 text-sm">처리 대기</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.pending_reviews || 0 }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                ✅
                            </div>
                            <div class="ml-4">
                                <p class="text-gray-600 text-sm">처리 완료</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.completed_reviews || 0 }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                ❌
                            </div>
                            <div class="ml-4">
                                <p class="text-gray-600 text-sm">처리 실패</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.failed_reviews || 0 }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 빠른 작업 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">⚡ 빠른 작업</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button @click="activeTab = 'reviews'; showReviewForm = true" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 text-center">
                            📝 새 리뷰 등록
                        </button>
                        <button v-if="user.role === 'admin'" @click="activeTab = 'google-sheets'" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 text-center">
                            📊 구글 시트 연동
                        </button>
                        <button v-if="user.role === 'admin'" @click="processAllPending" 
                                class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 text-center">
                            🚀 전체 처리 시작
                        </button>
                    </div>
                </div>
            </div>

            <!-- 리뷰 관리 탭 -->
            <div v-if="activeTab === 'reviews'" class="space-y-6">
                <!-- 리뷰 등록 폼 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">📝 리뷰 등록</h3>
                        <button @click="showReviewForm = !showReviewForm" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            {{ showReviewForm ? '폼 숨기기' : '새 리뷰 등록' }}
                        </button>
                    </div>
                    
                    <form v-if="showReviewForm" @submit.prevent="submitReview" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">업체 선택</label>
                            <select v-model="reviewForm.store_id" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">업체를 선택하세요</option>
                                <option v-for="store in stores" :key="store.id" :value="store.id">
                                    {{ store.name }} {{ store.location ? `(${store.location})` : '' }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">리뷰 URL</label>
                            <input v-model="reviewForm.review_url" type="url" required 
                                   placeholder="https://naver.me/... 또는 https://m.place.naver.com/my/review/..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-700 font-medium">✨ 지원 형식:</p>
                                <p class="text-xs text-blue-600">• 단축 URL: https://naver.me/5jBm0HYx</p>
                                <p class="text-xs text-blue-600">• 직접 링크: https://m.place.naver.com/my/review/...</p>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                등록
                            </button>
                            <button @click="showReviewForm = false" type="button" 
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">
                                취소
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 리뷰 목록 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">📋 리뷰 목록</h3>
                        <button @click="loadReviews" class="text-blue-600 hover:text-blue-800">
                            🔄 새로고침
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">업체명</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">URL 타입</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">등록일</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="review in reviews" :key="review.id" class="hover:bg-gray-50">
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">
                                        {{ review.store_name }}
                                    </td>
                                    <td class="px-6 py-4">
                                        <span :class="review.url_type === 'direct' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'" 
                                              class="px-2 py-1 text-xs font-medium rounded-full">
                                            {{ review.url_type === 'direct' ? '직접 링크' : '단축 URL' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span :class="getStatusColor(review.status)" 
                                              class="px-2 py-1 text-xs font-medium rounded-full">
                                            {{ getStatusText(review.status) }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">
                                        {{ formatDate(review.created_at) }}
                                    </td>
                                    <td class="px-6 py-4 space-x-2">
                                        <button v-if="review.status === 'pending'" 
                                                @click="processReview(review.id)" 
                                                class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                            ▶️ 처리
                                        </button>
                                        <button @click="viewReviewDetail(review)" 
                                                class="text-green-600 hover:text-green-900 text-sm font-medium">
                                            👁️ 상세
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="reviews.length === 0" class="text-center py-12 text-gray-500">
                            <p class="text-lg">📭 등록된 리뷰가 없습니다</p>
                            <p class="text-sm">새 리뷰를 등록해보세요!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 업체 관리 탭 (관리자만) -->
            <div v-if="activeTab === 'stores' && user.role === 'admin'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">🏪 업체 관리</h3>
                        <button @click="showStoreForm = !showStoreForm" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            {{ showStoreForm ? '폼 숨기기' : '새 업체 등록' }}
                        </button>
                    </div>
                    
                    <form v-if="showStoreForm" @submit.prevent="submitStore" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">업체명 *</label>
                            <input v-model="storeForm.name" type="text" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">설명</label>
                            <textarea v-model="storeForm.description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">위치</label>
                            <input v-model="storeForm.location" type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex space-x-3">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">등록</button>
                            <button @click="showStoreForm = false" type="button" 
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">취소</button>
                        </div>
                    </form>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div v-for="store in stores" :key="store.id" 
                             class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-gray-900 mb-2">{{ store.name }}</h4>
                            <p class="text-sm text-gray-600 mb-1">{{ store.description || '설명 없음' }}</p>
                            <p class="text-sm text-gray-500 mb-3">📍 {{ store.location || '위치 정보 없음' }}</p>
                            <div class="flex space-x-2">
                                <button class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    리뷰 {{ getStoreReviewCount(store.id) }}개
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 구글 시트 연동 탭 -->
            <div v-if="activeTab === 'google-sheets' && user.role === 'admin'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">📊 구글 시트 연동</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">구글 시트 ID</label>
                            <input v-model="googleSheetForm.sheet_id" type="text" 
                                   placeholder="1ABC123def... (구글 시트 URL에서 추출)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">
                                구글 시트 URL에서 ID 부분을 복사하세요: 
                                docs.google.com/spreadsheets/d/<strong>여기가ID</strong>/edit
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">인증 파일 업로드</label>
                            <input @change="handleCredentialsUpload" type="file" accept=".json" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">
                                Google Cloud Console에서 다운로드한 credentials.json 파일
                            </p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button @click="setupGoogleSheets" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                연결 설정
                            </button>
                            <button @click="syncWithGoogleSheets" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                데이터 동기화
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-bold text-yellow-800 mb-2">📋 구글 시트 설정 방법</h4>
                        <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                            <li>구글 시트에서 헤더 설정: A1(업체명), B1(리뷰URL), C1(리뷰본문), D1(영수증날짜), E1(등록일), F1(상태)</li>
                            <li>Google Cloud Console에서 Service Account 생성</li>
                            <li>credentials.json 파일 다운로드</li>
                            <li>구글 시트를 Service Account와 공유</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- 리뷰 상세 모달 -->
        <div v-if="selectedReview" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto z-50" @click="selectedReview = null">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white" @click.stop>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">🔍 리뷰 상세 정보</h3>
                    <button @click="selectedReview = null" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">업체명</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ selectedReview.store_name }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">상태</label>
                            <span :class="getStatusColor(selectedReview.status)" 
                                  class="mt-1 inline-block px-3 py-1 text-xs font-medium rounded-full">
                                {{ getStatusText(selectedReview.status) }}
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">리뷰 URL</label>
                        <div class="mt-1 p-2 bg-gray-50 rounded border">
                            <a :href="selectedReview.review_url" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm break-all">
                                {{ selectedReview.review_url }}
                            </a>
                        </div>
                    </div>
                    
                    <div v-if="selectedReview.extracted_review_text">
                        <label class="block text-sm font-medium text-gray-700">📝 추출된 리뷰 내용</label>
                        <div class="mt-1 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-sm text-gray-900 whitespace-pre-line">{{ selectedReview.extracted_review_text }}</p>
                        </div>
                    </div>
                    
                    <div v-if="selectedReview.extracted_receipt_date">
                        <label class="block text-sm font-medium text-gray-700">📅 영수증 날짜</label>
                        <p class="mt-1 text-sm text-gray-900 font-medium">{{ selectedReview.extracted_receipt_date }}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-500">
                        <div>
                            <label class="block font-medium">등록일</label>
                            <p>{{ formatDate(selectedReview.created_at) }}</p>
                        </div>
                        <div v-if="selectedReview.processed_at">
                            <label class="block font-medium">처리일</label>
                            <p>{{ formatDate(selectedReview.processed_at) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    user: null,
                    token: localStorage.getItem('token'),
                    loading: false,
                    loadingMessage: '처리중...',
                    activeTab: 'dashboard',
                    
                    loginForm: { username: '', password: '' },
                    
                    stats: {},
                    
                    reviews: [],
                    reviewForm: { store_id: '', review_url: '' },
                    showReviewForm: false,
                    selectedReview: null,
                    
                    stores: [],
                    storeForm: { name: '', description: '', location: '' },
                    showStoreForm: false,
                    
                    users: [],
                    userForm: { username: '', email: '', full_name: '', role: 'reviewer', password: '' },
                    showUserForm: false,
                    
                    googleSheetForm: { sheet_id: '' },
                    credentialsFile: null
                }
            },
            
            async mounted() {
                if (this.token) {
                    await this.getCurrentUser();
                }
            },
            
            methods: {
                async apiRequest(url, options = {}) {
                    const config = {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...(this.token && { 'Authorization': `Bearer ${this.token}` }),
                            ...options.headers
                        }
                    };
                    
                    try {
                        const response = await axios(url, config);
                        return response.data;
                    } catch (error) {
                        if (error.response?.status === 401) {
                            this.logout();
                        }
                        throw error;
                    }
                },
                
                async login() {
                    this.loading = true;
                    this.loadingMessage = '로그인 중...';
                    try {
                        const formData = new FormData();
                        formData.append('username', this.loginForm.username);
                        formData.append('password', this.loginForm.password);
                        
                        const response = await axios.post('/auth/login', formData);
                        this.token = response.data.access_token;
                        localStorage.setItem('token', this.token);
                        
                        await this.getCurrentUser();
                    } catch (error) {
                        alert('로그인 실패: ' + (error.response?.data?.detail || '알 수 없는 오류'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async getCurrentUser() {
                    try {
                        this.user = await this.apiRequest('/auth/me');
                        await this.loadDashboardData();
                    } catch (error) {
                        console.error('사용자 정보 로드 실패:', error);
                        this.logout();
                    }
                },
                
                logout() {
                    this.user = null;
                    this.token = null;
                    localStorage.removeItem('token');
                    this.activeTab = 'dashboard';
                },
                
                async loadDashboardData() {
                    try {
                        this.stats = await this.apiRequest('/api/dashboard/stats');
                        await this.loadStores();
                        await this.loadReviews();
                        if (this.user.role === 'admin') {
                            await this.loadUsers();
                        }
                    } catch (error) {
                        console.error('대시보드 로드 실패:', error);
                    }
                },
                
                async loadReviews() {
                    try {
                        this.reviews = await this.apiRequest('/api/reviews');
                    } catch (error) {
                        console.error('리뷰 목록 로드 실패:', error);
                    }
                },
                
                async loadStores() {
                    try {
                        this.stores = await this.apiRequest('/api/stores');
                    } catch (error) {
                        console.error('업체 목록 로드 실패:', error);
                    }
                },
                
                async loadUsers() {
                    try {
                        this.users = await this.apiRequest('/api/users');
                    } catch (error) {
                        console.error('사용자 목록 로드 실패:', error);
                    }
                },
                
                async submitReview() {
                    this.loading = true;
                    this.loadingMessage = '리뷰 등록 중...';
                    try {
                        await this.apiRequest('/api/reviews', {
                            method: 'POST',
                            data: this.reviewForm
                        });
                        
                        this.reviewForm = { store_id: '', review_url: '' };
                        this.showReviewForm = false;
                        await this.loadReviews();
                        await this.loadDashboardData();
                        alert('✅ 리뷰가 성공적으로 등록되었습니다!');
                    } catch (error) {
                        alert('❌ 리뷰 등록 실패: ' + (error.response?.data?.detail || '알 수 없는 오류'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async submitStore() {
                    this.loading = true;
                    this.loadingMessage = '업체 등록 중...';
                    try {
                        await this.apiRequest('/api/stores', {
                            method: 'POST',
                            data: this.storeForm
                        });
                        
                        this.storeForm = { name: '', description: '', location: '' };
                        this.showStoreForm = false;
                        await this.loadStores();
                        alert('✅ 업체가 성공적으로 등록되었습니다!');
                    } catch (error) {
                        alert('❌ 업체 등록 실패: ' + (error.response?.data?.detail || '알 수 없는 오류'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async processReview(reviewId) {
                    this.loading = true;
                    this.loadingMessage = '리뷰 추출 처리 중...';
                    try {
                        await this.apiRequest(`/api/reviews/${reviewId}/process`, {
                            method: 'POST'
                        });
                        
                        alert('🚀 리뷰 처리를 시작했습니다! 잠시 후 결과를 확인해주세요.');
                        setTimeout(() => {
                            this.loadReviews();
                            this.loadDashboardData();
                        }, 3000);
                    } catch (error) {
                        alert('❌ 리뷰 처리 실패: ' + (error.response?.data?.detail || '알 수 없는 오류'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async processAllPending() {
                    if (!confirm('모든 대기중인 리뷰를 처리하시겠습니까?')) return;
                    
                    this.loading = true;
                    this.loadingMessage = '전체 리뷰 처리 중...';
                    try {
                        const pendingReviews = this.reviews.filter(r => r.status === 'pending');
                        for (const review of pendingReviews) {
                            await this.apiRequest(`/api/reviews/${review.id}/process`, {
                                method: 'POST'
                            });
                        }
                        
                        alert(`🚀 ${pendingReviews.length}개 리뷰 처리를 시작했습니다!`);
                        setTimeout(() => {
                            this.loadReviews();
                            this.loadDashboardData();
                        }, 5000);
                    } catch (error) {
                        alert('❌ 일괄 처리 실패: ' + (error.response?.data?.detail || '알 수 없는 오류'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async setupGoogleSheets() {
                    if (!this.googleSheetForm.sheet_id) {
                        alert('구글 시트 ID를 입력해주세요');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = '구글 시트 연결 중...';
                    try {
                        await this.apiRequest('/api/google-sheets/setup', {
                            method: 'POST',
                            data: this.googleSheetForm
                        });
                        alert('✅ 구글 시트 연결 성공!');
                    } catch (error) {
                        alert('❌ 구글 시트 연결 실패: ' + (error.response?.data?.detail || '인증 파일을 먼저 업로드해주세요'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                async syncWithGoogleSheets() {
                    this.loading = true;
                    this.loadingMessage = '구글 시트 동기화 중...';
                    try {
                        const result = await this.apiRequest('/api/google-sheets/sync');
                        alert('✅ ' + result.message);
                        await this.loadReviews();
                        await this.loadDashboardData();
                    } catch (error) {
                        alert('❌ 동기화 실패: ' + (error.response?.data?.detail || '구글 시트 설정을 확인해주세요'));
                    } finally {
                        this.loading = false;
                    }
                },
                
                handleCredentialsUpload(event) {
                    this.credentialsFile = event.target.files[0];
                },
                
                viewReviewDetail(review) {
                    this.selectedReview = review;
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'pending': '⏳ 대기중',
                        'processing': '🔄 처리중',
                        'completed': '✅ 완료',
                        'failed': '❌ 실패'
                    };
                    return statusMap[status] || status;
                },
                
                getStatusColor(status) {
                    const colorMap = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800'
                    };
                    return colorMap[status] || 'bg-gray-100 text-gray-800';
                },
                
                getStoreReviewCount(storeId) {
                    return this.reviews.filter(r => r.store_name === this.stores.find(s => s.id === storeId)?.name).length;
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString('ko-KR');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>